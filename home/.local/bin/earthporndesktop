#!/usr/bin/python
import mimetypes
import os
import random
import requests
import subprocess

sub_url = "http://www.reddit.com/r/EarthPorn/top.json"
headers = {'User-Agent': 'earthpornbg v0.2'}
params = {'t': 'day'}
directory = '/home/julian/Pictures'
extensions = ('.jpg', '.jpeg', '.png')
basename = 'earthporndesktop_bg'
mimetypes.guess_extension('image/jpeg')  # hack to make result .jpeg
mimetypes.init()


def get_urls():
    response = requests.get(sub_url, params=params, headers=headers)
    response.raise_for_status()
    urls = [listing['data']['url']
            for listing in response.json()['data']['children']]
    return [url for url in urls if url.endswith(extensions)]


def fetch_image():
    urls = get_urls()
    random.shuffle(urls)
    for url in urls:
        response = requests.get(url, stream=True, headers=headers)
        ext = mimetypes.guess_extension(response.headers['Content-Type'])
        if ext in extensions:
            target = os.path.join(directory, "%s%s" % (basename, ext))
            with open(target, 'wb') as f:
                f.write(response.content)
            return target


def set_desktop(filename):
    subprocess.call(('feh', '--bg-scale', filename))


if __name__ == '__main__':
    filename = fetch_image()
    if filename is not None:
        set_desktop(filename)
